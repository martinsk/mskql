<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mskql</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* ── Playground (embedded) ───────────────────────────── */
        .playground-controls {
            display: flex;
            gap: 0.6rem;
            align-items: center;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }
        .playground-controls select {
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 0.95rem;
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--rule);
            background: var(--bg);
            color: var(--fg);
            border-radius: 3px;
        }
        .playground-controls button {
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 0.95rem;
            padding: 0.3rem 1rem;
            border: 1px solid var(--rule);
            background: var(--bg);
            color: var(--fg);
            border-radius: 3px;
            cursor: pointer;
        }
        .playground-controls button:hover { border-color: var(--accent); color: var(--accent); }
        .run-btn { background: var(--accent) !important; color: #fff !important; border-color: var(--accent) !important; font-weight: 600; }
        .run-btn:hover { background: #800 !important; }
        .run-btn:disabled { opacity: 0.5; cursor: default; }

        .editor-wrap {
            position: relative;
            min-height: 160px;
            border: 1px solid var(--rule);
            border-left: 3px solid var(--accent);
            background: var(--code-bg);
            border-radius: 0;
        }
        .editor-wrap pre {
            margin: 0;
            padding: 1rem 1.2rem;
            border: none;
            background: transparent;
            font-family: 'Menlo', 'Consolas', 'DejaVu Sans Mono', monospace;
            font-size: 0.82rem;
            line-height: 1.55;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            pointer-events: none;
        }
        .editor-wrap pre code {
            font-family: inherit;
            font-size: inherit;
            background: none;
            padding: 0;
            border-radius: 0;
        }
        .editor-wrap pre code.hljs {
            background: transparent;
            padding: 0;
        }
        #sql-input {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            font-family: 'Menlo', 'Consolas', 'DejaVu Sans Mono', monospace;
            font-size: 0.82rem;
            line-height: 1.55;
            padding: 1rem 1.2rem;
            border: none;
            background: transparent;
            color: transparent;
            caret-color: var(--fg);
            resize: none;
            tab-size: 4;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto;
        }
        #sql-input::selection {
            background: rgba(160, 0, 0, 0.2);
            color: transparent;
        }

        .pg-status {
            font-size: 0.85rem;
            color: var(--fg-dim);
            margin-top: 0.4rem;
            margin-bottom: 1rem;
            min-height: 1.2em;
        }
        .pg-status.error { color: var(--accent); }

        .pg-result-wrap {
            overflow-x: auto;
            margin-top: 0.5rem;
        }
        .pg-result-table {
            border-collapse: collapse;
            font-size: 0.85rem;
            width: 100%;
            font-family: 'Menlo', 'Consolas', 'DejaVu Sans Mono', monospace;
        }
        .pg-result-table th {
            text-align: left;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-bottom: 2px solid var(--fg);
            white-space: nowrap;
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 0.95rem;
        }
        .pg-result-table td {
            padding: 0.3rem 0.8rem;
            border-bottom: 1px solid var(--rule);
            white-space: pre;
        }
        .pg-result-table tr:last-child td { border-bottom: 2px solid var(--fg); }
        .pg-result-table .null-cell { color: var(--fg-dim); font-style: italic; }

        .pg-result-message {
            font-size: 0.95rem;
            color: var(--fg-dim);
            padding: 0.8rem 0;
            font-style: italic;
        }
        .pg-result-message.error-msg {
            color: var(--accent);
            font-style: normal;
            font-family: 'Menlo', 'Consolas', monospace;
            font-size: 0.82rem;
        }

        /* ── CTA cards ───────────────────────────────────────── */
        .cta-row {
            display: flex;
            gap: 1.2rem;
            margin: 2rem 0;
        }
        .cta-card {
            flex: 1;
            border: 1px solid var(--rule);
            padding: 1.2rem 1.4rem;
            border-radius: 4px;
            background: #fff;
        }
        .cta-card h3 {
            margin-top: 0;
            margin-bottom: 0.4rem;
        }
        .cta-card p {
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }
        .cta-card a.cta-link {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent);
            background-image: none;
        }
        @media (max-width: 700px) {
            .cta-row { flex-direction: column; }
            .ai-split { flex-direction: column; }
        }

        /* ── Benchmark summary ───────────────────────────────── */
        .bench-faster { color: #1a7a1a; font-weight: 600; }
        .bench-slower { color: var(--accent); font-weight: 600; }
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  WHAT: Title block                                          -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h1>mskql</h1>
<span class="subtitle">A lightweight, in-memory SQL database engine written in&nbsp;C</span>
<p class="byline">
    <a href="https://www.linkedin.com/in/martinskristiansen" class="author-name"><strong>Martin S. Kristiansen</strong></a>
    &ensp;&middot;&ensp;
    <a href="https://github.com/martinsk/mskql">github.com/martinsk/mskql</a>
    &ensp;&middot;&ensp;
    <a href="tutorials/index.html">Tutorials</a>
    &ensp;&middot;&ensp; ~23,800 lines of C11 &ensp;&middot;&ensp; 892 test cases &ensp;&middot;&ensp; zero dependencies
</p>
<hr class="title-rule">

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  Navigation strip                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->

<nav class="toc-strip">
<a href="#wire-compat">Wire protocol</a>
<a href="#performance">Performance</a>
<a href="#ai-built">AI-built</a>
<a href="#try-it">Playground</a>
<span class="toc-sep"></span>
<a href="getting-started.html">Getting Started</a>
<a href="architecture.html">Architecture</a>
<a href="sql-reference.html">SQL Reference</a>
<a href="bench-vs-pg.html">Benchmarks</a>
<a href="testing.html">Testing</a>
<a href="grammar.html">Grammar</a>
<a href="tutorials/index.html">Tutorials</a>
</nav>

<div class="epigraph">
    <blockquote>
        No configuration files. No third-party libraries. Build and go.
    </blockquote>
</div>

<p>
    mskql distills the core ideas of a database engine&mdash;wire protocol, parser,
    query executor, storage engine, arena allocator, block-oriented plan
    executor&mdash;into ~23,800 readable lines of C11 with zero dependencies.
    Every layer is visible and modifiable. The entire project was built by
    AI agents through an adversarial collaboration; no human wrote any C code
    or SQL test case.<span class="sidenote">The codebase is structured so each subsystem
    (<code>pgwire.c</code>, <code>parser.c</code>, <code>query.c</code>,
    <code>plan.c</code>, <code>database.c</code>) can be studied in isolation.
    No generated code, no macros hiding control flow.</span>
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  SO WHAT: Three proof points                                -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="wire-compat">PostgreSQL wire-protocol compatible</h2>

<p>
    mskql implements the PostgreSQL wire protocol&nbsp;(v3) directly&mdash;Simple Query,
    Extended Query (prepared statements, portals, <code>$1</code>/<code>$2</code>
    parameter substitution), and COPY. Any tool that speaks Postgres works without
    modification: <code>psql</code>, pgAdmin, DBeaver, any language
    driver.<span class="sidenote">The default port is&nbsp;5433, configurable
    via <code>MSKQL_PORT</code>.</span>
</p>

<pre><code class="language-bash">make && ./build/mskql                         # build & start
psql -h 127.0.0.1 -p 5433 -U test -d mskql   # connect</code></pre>

<h2 id="performance">Performance vs PostgreSQL</h2>

<p>
    Two benchmarks tell the story: batch latency (single client, sequential) and
    concurrent throughput (10 threads, 5&nbsp;seconds). The contrast reveals where
    an in-memory engine wins and where production engineering matters.
</p>

<table>
    <thead>
        <tr><th>Workload</th><th>Type</th><th>Ratio</th><th></th></tr>
    </thead>
    <tbody>
        <tr><td>aggregate</td><td>batch</td><td class="bench-faster">0.16&times;</td><td>mskql 6&times; faster</td></tr>
        <tr><td>distinct</td><td>batch</td><td class="bench-faster">0.18&times;</td><td>mskql 5.5&times; faster</td></tr>
        <tr><td>join</td><td>batch</td><td class="bench-faster">0.47&times;</td><td>mskql 2&times; faster</td></tr>
        <tr><td>order_by</td><td>batch</td><td class="bench-faster">0.53&times;</td><td>mskql 2&times; faster</td></tr>
        <tr><td>aggregate</td><td>throughput</td><td class="bench-faster">2.55&times; QPS</td><td>mskql wins under load</td></tr>
        <tr><td>point_read</td><td>throughput</td><td class="bench-slower">0.74&times; QPS</td><td>PG wins under load</td></tr>
        <tr><td>join</td><td>throughput</td><td class="bench-slower">0.01&times; QPS</td><td>single-threaded bottleneck</td></tr>
    </tbody>
</table>

<p>
    &#8594;&ensp;<a href="bench-vs-pg.html"><strong>Full benchmark comparison</strong></a>
    &ensp;&middot;&ensp;
    <a href="dev/bench/index.html"><strong>Historical charts</strong></a>
</p>

<h2 id="ai-built">Built entirely by AI agents</h2>

<div class="ai-split" style="display:flex; gap:2rem; align-items:flex-start; margin:1rem 0 1.4rem 0;">
<div style="flex:1 1 50%; min-width:0;">
<p style="margin-bottom:0.8rem;">
    Three agents collaborated in iterative rounds. The <strong>Challenger</strong>
    writes adversarial SQL tests designed to break the system. The
    <strong>Reviewer</strong> reads the source and flags code-quality issues.
    The <strong>Writer</strong> runs the tests, addresses feedback, and ships
    fixes&mdash;repeating until all 892 tests pass cleanly.
</p>
<p style="margin-bottom:0.8rem;">
    No human wrote any of the C code or SQL test cases. The adversarial model
    drove the implementation toward correctness the same way rigorous code review
    does on a human team&mdash;except all three sides were machines.
</p>
<p style="margin-bottom:0;">
    &#8594;&ensp;<a href="construction.html"><strong>Read more about the process</strong></a>
</p>
</div>
<div style="flex:1 1 50%; min-width:0;">
<svg viewBox="0 0 340 110" xmlns="http://www.w3.org/2000/svg" font-family="'EB Garamond', Georgia, serif" style="width:100%; height:auto;">
  <rect width="340" height="110" fill="#fffff8"/>
  <defs>
    <marker id="ah" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto">
      <path d="M0,0 L6,2.5 L0,5" fill="#a00"/>
    </marker>
  </defs>
  <rect x="8" y="8" width="88" height="44" rx="4" fill="#fff" stroke="#111" stroke-width="1.2"/>
  <text x="52" y="26" text-anchor="middle" font-size="11" font-weight="600" fill="#111">Challenger</text>
  <text x="52" y="42" text-anchor="middle" font-size="8.5" fill="#555">adversarial tests</text>
  <rect x="126" y="8" width="88" height="44" rx="4" fill="#fff" stroke="#111" stroke-width="1.2"/>
  <text x="170" y="26" text-anchor="middle" font-size="11" font-weight="600" fill="#111">Writer</text>
  <text x="170" y="42" text-anchor="middle" font-size="8.5" fill="#555">writes &amp; fixes</text>
  <rect x="244" y="8" width="88" height="44" rx="4" fill="#fff" stroke="#111" stroke-width="1.2"/>
  <text x="288" y="26" text-anchor="middle" font-size="11" font-weight="600" fill="#111">Reviewer</text>
  <text x="288" y="42" text-anchor="middle" font-size="8.5" fill="#555">code review</text>
  <path d="M96,22 L126,22" stroke="#a00" stroke-width="1.2" fill="none" marker-end="url(#ah)"/>
  <path d="M126,40 L96,40" stroke="#a00" stroke-width="1.2" fill="none" marker-end="url(#ah)"/>
  <path d="M214,22 L244,22" stroke="#a00" stroke-width="1.2" fill="none" marker-end="url(#ah)"/>
  <path d="M244,40 L214,40" stroke="#a00" stroke-width="1.2" fill="none" marker-end="url(#ah)"/>
  <path d="M288,52 C288,72 170,78 52,72 C30,71 18,66 18,52"
        stroke="#ccc" stroke-width="1" fill="none" stroke-dasharray="3,2"/>
  <text x="170" y="90" text-anchor="middle" font-size="8.5" fill="#555" font-style="italic">iterate until all 892 tests pass</text>
</svg>
</div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  NOW WHAT: Embedded playground                              -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="try-it">Try it &mdash; right here</h2>

<p>
    A fully functional mskql database running <strong>entirely in your browser</strong>
    via WebAssembly&mdash;no server, no network requests. Choose an example or write
    your own SQL.
</p>

<div class="playground-controls">
    <select id="examples" aria-label="Example queries">
        <option value="">— Choose an example —</option>
        <option value="basics">Create, Insert &amp; Select</option>
        <option value="joins">Joins</option>
        <option value="aggregation">Aggregation &amp; GROUP BY</option>
        <option value="window">Window Functions</option>
        <option value="generate_series">generate_series()</option>
        <option value="cte">Common Table Expressions</option>
        <option value="upsert">Upsert (ON CONFLICT)</option>
        <option value="datetime">Date/Time Arithmetic</option>
    </select>
    <button class="run-btn" id="run-btn" disabled>&#9654; Run</button>
    <button id="reset-btn" disabled>Reset DB</button>
</div>

<div class="editor-wrap">
    <pre><code id="sql-highlight" class="language-sql"></code></pre>
    <textarea id="sql-input" spellcheck="false" placeholder="Enter SQL here...">CREATE TABLE users (
    id INT PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT,
    age INT
);

INSERT INTO users VALUES
    (1, 'Alice',   'alice@example.com',   32),
    (2, 'Bob',     'bob@example.com',     28),
    (3, 'Charlie', 'charlie@example.com', 35),
    (4, 'Diana',   'diana@example.com',   29);

SELECT * FROM users WHERE age > 30 ORDER BY name;</textarea>
</div>

<div class="pg-status" id="pg-status">Loading WebAssembly&hellip;</div>

<div id="pg-result">
    <div class="pg-result-message">Run a query to see results here.</div>
</div>

<p style="font-size:0.9rem; color:var(--fg-dim); margin-top:0.5rem;">
    &#8594;&ensp;<a href="playground.html"><strong>Open full playground</strong></a>
    &ensp;(more space, more examples)
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  CTA cards                                                  -->
<!-- ═══════════════════════════════════════════════════════════ -->

<div class="cta-row">
    <div class="cta-card">
        <h3>Build &amp; connect</h3>
        <p>Ten queries from <code>CREATE TABLE</code> to recursive CTEs, all through <code>psql</code>.</p>
        <a href="getting-started.html" class="cta-link">Getting started &rarr;</a>
    </div>
    <div class="cta-card">
        <h3>Read the source</h3>
        <p>~23,800 lines of C11. Every subsystem in a single file.</p>
        <a href="https://github.com/martinsk/mskql" class="cta-link">GitHub &rarr;</a>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  Below the fold: compact reference pointers                 -->
<!-- ═══════════════════════════════════════════════════════════ -->

<hr>

<h2 id="architecture">Architecture</h2>

<table>
    <thead>
        <tr><th>Stage</th><th>Source</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Wire protocol</strong></td>
            <td><code>pgwire.c</code></td>
            <td>PostgreSQL v3 wire protocol: Simple Query, Extended Query, COPY</td>
        </tr>
        <tr>
            <td><strong>SQL parser</strong></td>
            <td><code>parser.c</code></td>
            <td>Hand-written recursive-descent parser &rarr; typed AST</td>
        </tr>
        <tr>
            <td><strong>Query executor</strong></td>
            <td><code>query.c</code>, <code>plan.c</code></td>
            <td>Block-oriented vectorized executor (1,024-row column blocks) with legacy row-at-a-time fallback</td>
        </tr>
        <tr>
            <td><strong>Storage</strong></td>
            <td><code>table.c</code>, <code>index.c</code></td>
            <td>In-memory row store, B-tree indexes, snapshot-based transactions</td>
        </tr>
    </tbody>
</table>

<p>
    &#8594;&ensp;<a href="architecture.html"><strong>Full architecture details</strong></a>
    &ensp;(memory management, arena allocator, expression evaluator)
</p>

<h2 id="sql">SQL coverage</h2>

<table>
    <thead>
        <tr><th>Category</th><th>Highlights</th></tr>
    </thead>
    <tbody>
        <tr><td><strong>DDL</strong></td><td>Create / drop / alter tables, indexes, views, sequences, enums</td></tr>
        <tr><td><strong>DML</strong></td><td>Insert (multi-row, upsert, returning), select, update, delete, copy, truncate</td></tr>
        <tr><td><strong>Joins</strong></td><td>Inner, left, right, full outer, cross, lateral, natural, using</td></tr>
        <tr><td><strong>Aggregation</strong></td><td>Count, sum, avg, min, max, string_agg, array_agg &middot; rollup, cube, having</td></tr>
        <tr><td><strong>Window functions</strong></td><td>row_number, rank, dense_rank, ntile, lag, lead &middot; frame clauses</td></tr>
        <tr><td><strong>CTEs &amp; set ops</strong></td><td>With, with recursive &middot; union, intersect, except</td></tr>
        <tr><td><strong>Subqueries</strong></td><td>Scalar, correlated, exists, in (select&hellip;)</td></tr>
        <tr><td><strong>Expressions</strong></td><td>Case/when, coalesce, cast/::, 30+ math/string/date-time functions</td></tr>
        <tr><td><strong>Other</strong></td><td>generate_series, constraints, foreign keys, transactions, sequences</td></tr>
    </tbody>
</table>

<p>
    &#8594;&ensp;<a href="sql-reference.html"><strong>Full SQL reference</strong></a>
    &ensp;&middot;&ensp;
    <a href="grammar.html"><strong>Grammar</strong></a>
</p>

<h2 id="testing">Testing</h2>

<p>
    892 test cases with <strong>two layers of verification</strong>: functional correctness
    (output diff) and memory safety (AddressSanitizer + LeakSanitizer on every test).
    A correct query that leaks memory is a failure. Tests run in parallel across all CPU
    cores, each in an isolated server instance. Additional C-level test suites exercise
    the Extended Query Protocol and multi-client concurrency.
</p>

<p>
    &#8594;&ensp;<a href="testing.html"><strong>Testing methodology</strong></a>
</p>

<h2 id="benchmarks">Benchmarks</h2>

<p>
    A micro-benchmark suite measures wall-clock time for core operations: bulk insert,
    full-table scan, filtered select, aggregation, ordering, joins, update, delete,
    parsing, index lookup, and transactions. Results are tracked continuously via CI.
</p>

<p>
    &#8594;&ensp;<a href="dev/bench/index.html"><strong>Historical benchmark charts</strong></a>
    <br>
    &#8594;&ensp;<a href="bench-vs-pg.html"><strong>mskql vs PostgreSQL comparison</strong></a>
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  Footer                                                     -->
<!-- ═══════════════════════════════════════════════════════════ -->

<footer class="site-footer">
    <a href="https://www.linkedin.com/in/martinskristiansen">Martin S. Kristiansen</a>
    &ensp;&middot;&ensp;
    <a href="https://github.com/martinsk/mskql">Source on GitHub</a>
    &ensp;&middot;&ensp;
    <a href="getting-started.html">Getting Started</a>
    &ensp;&middot;&ensp;
    <a href="architecture.html">Architecture</a>
    &ensp;&middot;&ensp;
    <a href="sql-reference.html">SQL Reference</a>
    &ensp;&middot;&ensp;
    <a href="testing.html">Testing</a>
    &ensp;&middot;&ensp;
    <a href="bench-vs-pg.html">Benchmarks</a>
    &ensp;&middot;&ensp;
    <a href="grammar.html">Grammar</a>
    &ensp;&middot;&ensp;
    <a href="tutorials/index.html">Tutorials</a>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="wasm/mskql-wasm.js"></script>
<script>
(function() {
    const db = new MskqlDB();
    const sqlInput   = document.getElementById('sql-input');
    const runBtn     = document.getElementById('run-btn');
    const resetBtn   = document.getElementById('reset-btn');
    const statusEl   = document.getElementById('pg-status');
    const resultEl   = document.getElementById('pg-result');
    const examplesEl = document.getElementById('examples');
    const highlightEl = document.getElementById('sql-highlight');

    function syncHighlight() {
        highlightEl.textContent = sqlInput.value + '\n';
        delete highlightEl.dataset.highlighted;
        hljs.highlightElement(highlightEl);
    }
    sqlInput.addEventListener('input', syncHighlight);
    sqlInput.addEventListener('scroll', function() {
        highlightEl.parentElement.scrollTop = sqlInput.scrollTop;
        highlightEl.parentElement.scrollLeft = sqlInput.scrollLeft;
    });

    var examples = {
        basics: "CREATE TABLE users (\n    id INT PRIMARY KEY,\n    name TEXT NOT NULL,\n    email TEXT,\n    age INT\n);\n\nINSERT INTO users VALUES\n    (1, 'Alice',   'alice@example.com',   32),\n    (2, 'Bob',     'bob@example.com',     28),\n    (3, 'Charlie', 'charlie@example.com', 35),\n    (4, 'Diana',   'diana@example.com',   29);\n\nSELECT * FROM users WHERE age > 30 ORDER BY name;",

        joins: "CREATE TABLE departments (id INT PRIMARY KEY, name TEXT);\nINSERT INTO departments VALUES (1, 'Engineering'), (2, 'Marketing'), (3, 'Sales');\n\nCREATE TABLE employees (id INT PRIMARY KEY, name TEXT, dept_id INT, salary INT);\nINSERT INTO employees VALUES\n    (1, 'Alice', 1, 95000), (2, 'Bob', 1, 88000),\n    (3, 'Charlie', 2, 72000), (4, 'Diana', 3, 81000),\n    (5, 'Eve', 2, 69000);\n\nSELECT e.name, d.name AS department, e.salary\nFROM employees e\nJOIN departments d ON e.dept_id = d.id\nORDER BY e.salary DESC;",

        aggregation: "CREATE TABLE sales (\n    id INT PRIMARY KEY,\n    product TEXT,\n    region TEXT,\n    amount NUMERIC\n);\n\nINSERT INTO sales VALUES\n    (1, 'Widget', 'North', 150.00),\n    (2, 'Widget', 'South', 200.00),\n    (3, 'Gadget', 'North', 300.00),\n    (4, 'Gadget', 'South', 250.00),\n    (5, 'Widget', 'North', 175.00),\n    (6, 'Gadget', 'North', 325.00);\n\nSELECT product, region,\n       COUNT(*) AS num_sales,\n       SUM(amount) AS total,\n       AVG(amount) AS avg_sale\nFROM sales\nGROUP BY product, region\nORDER BY product, region;",

        window: "CREATE TABLE scores (\n    student TEXT,\n    subject TEXT,\n    score INT\n);\n\nINSERT INTO scores VALUES\n    ('Alice', 'Math', 92), ('Alice', 'English', 88),\n    ('Bob', 'Math', 85), ('Bob', 'English', 91),\n    ('Charlie', 'Math', 96), ('Charlie', 'English', 79),\n    ('Diana', 'Math', 88), ('Diana', 'English', 94);\n\nSELECT student, subject, score,\n       RANK() OVER (PARTITION BY subject ORDER BY score DESC) AS rank,\n       AVG(score) OVER (PARTITION BY subject) AS subject_avg\nFROM scores\nORDER BY subject, rank;",

        generate_series: "SELECT n, n * n AS square\nFROM generate_series(1, 10) AS g(n);",

        cte: "CREATE TABLE tree (id INT PRIMARY KEY, parent_id INT, name TEXT);\nINSERT INTO tree VALUES\n    (1, NULL, 'Root'),\n    (2, 1, 'Child A'), (3, 1, 'Child B'),\n    (4, 2, 'Grandchild A1'), (5, 2, 'Grandchild A2'),\n    (6, 3, 'Grandchild B1');\n\nWITH RECURSIVE descendants AS (\n    SELECT id, name, 0 AS depth FROM tree WHERE parent_id IS NULL\n    UNION ALL\n    SELECT t.id, t.name, d.depth + 1\n    FROM tree t JOIN descendants d ON t.parent_id = d.id\n)\nSELECT depth, name FROM descendants ORDER BY depth, name;",

        upsert: "CREATE TABLE kv (key TEXT PRIMARY KEY, value INT);\n\nINSERT INTO kv VALUES ('a', 1), ('b', 2), ('c', 3);\n\nINSERT INTO kv VALUES ('b', 20), ('d', 4)\nON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;\n\nSELECT * FROM kv ORDER BY key;",

        datetime: "SELECT\n    '2024-01-15'::date + 30 AS plus_30_days,\n    '2024-06-15 10:30:00'::timestamp - '2024-01-01 00:00:00'::timestamp AS diff,\n    EXTRACT(MONTH FROM '2024-03-15'::date) AS month,\n    DATE_TRUNC('month', '2024-03-15'::date) AS trunc_month;"
    };

    examplesEl.addEventListener('change', function() {
        if (this.value && examples[this.value]) {
            sqlInput.value = examples[this.value];
            syncHighlight();
            this.selectedIndex = 0;
        }
    });

    function runQuery() {
        var sql = sqlInput.value.trim();
        if (!sql) return;

        statusEl.className = 'pg-status';
        statusEl.textContent = 'Running\u2026';

        setTimeout(function() {
            var t0 = performance.now();
            var res = db.exec(sql);
            var elapsed = (performance.now() - t0).toFixed(1);

            if (!res.ok) {
                statusEl.className = 'pg-status error';
                statusEl.textContent = 'Error (' + elapsed + ' ms)';
                resultEl.innerHTML = '<div class="pg-result-message error-msg">' +
                    escapeHtml(res.output) + '</div>';
                return;
            }

            var output = res.output.trim();
            if (output === 'OK' || output === '') {
                statusEl.className = 'pg-status';
                statusEl.textContent = 'OK (' + elapsed + ' ms)';
                resultEl.innerHTML = '<div class="pg-result-message">Statement executed successfully.</div>';
                return;
            }

            var lines = output.split('\n').filter(function(l) { return l.length > 0; });
            if (lines.length === 0) {
                statusEl.className = 'pg-status';
                statusEl.textContent = '0 rows (' + elapsed + ' ms)';
                resultEl.innerHTML = '<div class="pg-result-message">Query returned no rows.</div>';
                return;
            }

            var headers = lines[0].split('\t');
            var dataLines = lines.slice(1);

            statusEl.className = 'pg-status';
            statusEl.textContent = dataLines.length + ' row' + (dataLines.length !== 1 ? 's' : '') + ' (' + elapsed + ' ms)';

            var html = '<div class="pg-result-wrap"><table class="pg-result-table">';
            html += '<thead><tr>';
            for (var j = 0; j < headers.length; j++) {
                html += '<th>' + escapeHtml(headers[j]) + '</th>';
            }
            html += '</tr></thead><tbody>';
            for (var i = 0; i < dataLines.length; i++) {
                var cells = dataLines[i].split('\t');
                html += '<tr>';
                for (var j2 = 0; j2 < cells.length; j2++) {
                    var val = cells[j2];
                    if (val === 'NULL') {
                        html += '<td class="null-cell">NULL</td>';
                    } else {
                        html += '<td>' + escapeHtml(val) + '</td>';
                    }
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            resultEl.innerHTML = html;
        }, 10);
    }

    function escapeHtml(s) {
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    runBtn.addEventListener('click', runQuery);

    sqlInput.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            runQuery();
        }
        if (e.key === 'Tab') {
            e.preventDefault();
            var start = this.selectionStart;
            var end = this.selectionEnd;
            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }
    });

    resetBtn.addEventListener('click', function() {
        db.reset();
        statusEl.className = 'pg-status';
        statusEl.textContent = 'Database reset.';
        resultEl.innerHTML = '<div class="pg-result-message">Database has been reset. All tables dropped.</div>';
    });

    syncHighlight();

    db.init('wasm/mskql.wasm').then(function() {
        statusEl.textContent = 'Database ready. Press Run or Ctrl+Enter.';
        runBtn.disabled = false;
        resetBtn.disabled = false;
    }).catch(function(err) {
        statusEl.className = 'pg-status error';
        statusEl.textContent = 'Failed to load: ' + err.message;
        console.error(err);
    });

    hljs.highlightAll();
})();
</script>

</body>
</html>
