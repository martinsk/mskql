<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mskql</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <style>
        /* ── Reset & base ────────────────────────────────────── */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --body-width: 55%;
            --fg: #111;
            --fg-dim: #555;
            --bg: #fffff8;
            --accent: #a00;
            --rule: #ccc;
            --code-bg: #f3f1eb;
            --sidenote-width: 300px;
        }

        html { font-size: 15px; }

        body {
            font-family: 'EB Garamond', 'Palatino Linotype', Palatino, 'Book Antiqua', Georgia, serif;
            background: var(--bg);
            color: var(--fg);
            width: var(--body-width);
            margin-left: auto;
            margin-right: auto;
            padding: 3rem 0 5rem 0;
            counter-reset: sidenote-counter;
        }

        /* ── Typography ──────────────────────────────────────── */
        p, ol, ul, dl { font-size: 1.1rem; line-height: 1.7; margin-bottom: 1.2rem; }
        li { margin-bottom: 0.3rem; }
        ol, ul { padding-left: 1.6rem; }

        a { color: var(--fg); text-decoration: none; background-image: linear-gradient(var(--accent), var(--accent)); background-size: 1px 1px; background-repeat: repeat-x; background-position: 0 1.15em; }
        a:hover { color: var(--accent); }

        strong { font-weight: 600; }

        /* ── Headings ────────────────────────────────────────── */
        h1 {
            font-weight: 400;
            font-size: 2.6rem;
            line-height: 1.15;
            margin-bottom: 0.4rem;
        }

        .subtitle {
            font-style: italic;
            font-size: 1.3rem;
            color: var(--fg-dim);
            display: block;
            margin-bottom: 0.6rem;
            line-height: 1.4;
        }

        .byline {
            font-size: 0.95rem;
            color: var(--fg-dim);
            margin-bottom: 2rem;
        }
        .byline a { font-size: 0.95rem; }

        h2 {
            font-weight: 400;
            font-style: italic;
            font-size: 1.6rem;
            margin-top: 2.8rem;
            margin-bottom: 0.6rem;
            padding-bottom: 0.15rem;
        }

        h3 {
            font-weight: 600;
            font-style: normal;
            font-size: 1.15rem;
            margin-top: 1.6rem;
            margin-bottom: 0.4rem;
        }

        /* ── Accent rule under title ─────────────────────────── */
        .title-rule {
            border: none;
            height: 3px;
            background: var(--accent);
            width: 60px;
            margin: 0 0 2rem 0;
        }

        /* ── Epigraph ────────────────────────────────────────── */
        .epigraph {
            margin: 2.5rem 0 2.5rem 0;
            padding: 0;
        }
        .epigraph blockquote {
            font-style: italic;
            font-size: 1.05rem;
            line-height: 1.65;
            margin: 0;
            padding: 0 0 0 1.5rem;
            border-left: 3px solid var(--accent);
        }
        .epigraph blockquote footer {
            font-style: normal;
            font-size: 0.9rem;
            color: var(--fg-dim);
            margin-top: 0.5rem;
        }

        /* ── Sidenotes / margin notes ────────────────────────── */
        .sidenote, .marginnote {
            float: right;
            clear: right;
            margin-right: calc(-1 * var(--sidenote-width) - 40px);
            width: var(--sidenote-width);
            font-size: 0.85rem;
            line-height: 1.45;
            color: var(--fg-dim);
            vertical-align: baseline;
            position: relative;
        }
        .sidenote { counter-increment: sidenote-counter; }
        .sidenote::before {
            content: counter(sidenote-counter);
            font-size: 0.7rem;
            position: relative;
            top: -0.4rem;
            padding-right: 0.15rem;
            color: var(--accent);
            font-weight: 600;
        }
        sup.sidenote-ref {
            font-size: 0.7rem;
            color: var(--accent);
            font-weight: 600;
            cursor: default;
        }
        sup.sidenote-ref::after {
            content: counter(sidenote-counter);
            counter-increment: sidenote-counter;
        }

        /* ── Code ────────────────────────────────────────────── */
        code {
            font-family: 'Menlo', 'Consolas', 'DejaVu Sans Mono', monospace;
            font-size: 0.82rem;
            background: var(--code-bg);
            padding: 0.1em 0.35em;
            border-radius: 2px;
        }
        pre {
            background: var(--code-bg);
            border-left: 3px solid var(--accent);
            padding: 1rem 1.2rem;
            overflow-x: auto;
            font-size: 0.82rem;
            line-height: 1.55;
            margin: 1rem 0 1.4rem 0;
        }
        pre code { background: none; padding: 0; border-radius: 0; }

        /* ── Tables (Tufte: full-width, minimal rules) ───────── */
        .fullwidth { width: 100%; }
        table {
            border-collapse: collapse;
            font-size: 0.95rem;
            width: 100%;
            margin: 1rem 0 1.4rem 0;
        }
        th, td {
            padding: 0.4rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--rule);
        }
        thead th {
            border-bottom: 2px solid var(--fg);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        tbody tr:last-child td { border-bottom: 2px solid var(--fg); }
        td code { font-size: 0.8rem; }

        /* ── Divider ─────────────────────────────────────────── */
        hr {
            border: none;
            border-top: 1px solid var(--rule);
            margin: 2.5rem 0;
        }

        /* ── Footer ──────────────────────────────────────────── */
        footer.site-footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--rule);
            font-size: 0.85rem;
            color: var(--fg-dim);
        }
        footer.site-footer a { font-size: 0.85rem; }

        /* ── Diagram ─────────────────────────────────────────── */
        .diagram {
            margin: 2rem auto;
            text-align: center;
        }
        .diagram svg {
            max-width: 100%;
            height: auto;
        }

        /* ── Responsive: collapse sidenotes on narrow screens ── */
        @media (max-width: 1100px) {
            body { width: 80%; }
            .sidenote, .marginnote {
                float: none;
                display: block;
                margin: 0.8rem 0 0.8rem 1.5rem;
                width: auto;
                font-size: 0.9rem;
                color: var(--fg-dim);
                border-left: 2px solid var(--rule);
                padding-left: 0.8rem;
            }
        }
        @media (max-width: 700px) {
            body { width: 90%; padding: 2rem 0 3rem 0; }
            h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  Title block                                                -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h1>mskql</h1>
<span class="subtitle">A lightweight, in-memory SQL database engine written in&nbsp;C</span>
<p class="byline">
    <a href="https://github.com/martinsk/mskql">github.com/martinsk/mskql</a>
    &ensp;&middot;&ensp; ~8,200 lines of C11 &ensp;&middot;&ensp; 241 test cases &ensp;&middot;&ensp; zero dependencies
</p>
<hr class="title-rule">

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  Epigraph                                                   -->
<!-- ═══════════════════════════════════════════════════════════ -->

<div class="epigraph">
    <blockquote>
        No configuration files. No third-party libraries. Build and go.
    </blockquote>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  1. Motivation                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="motivation">1. Motivation</h2>

<p>
    Most embeddable databases either expose a custom API or implement a subset of SQL
    behind a proprietary protocol. mskql takes a different approach: it implements the
    PostgreSQL wire protocol&nbsp;(v3) directly, so any tool that can talk to Postgres can
    talk to mskql without modification.<span class="sidenote">This means <code>psql</code>,
    pgAdmin, DBeaver, any language driver for Postgres&mdash;they all work out of the box
    on port&nbsp;5433.</span>
    The goal is a minimal, understandable, single-binary database useful for prototyping,
    testing, and education.
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  2. Architecture                                            -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="architecture">2. Architecture</h2>

<p>
    The system is structured as a pipeline of four stages:
</p>

<table>
    <thead>
        <tr><th>Stage</th><th>Source</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Wire protocol</strong></td>
            <td><code>pgwire.c</code></td>
            <td>Accepts TCP connections on port&nbsp;5433, handles SSL negotiation,
                parses PostgreSQL startup/query messages, serializes result rows</td>
        </tr>
        <tr>
            <td><strong>SQL parser</strong></td>
            <td><code>parser.c</code></td>
            <td>Hand-written recursive-descent parser producing a typed
                <code>struct&nbsp;query</code> AST&mdash;no generators<span class="sidenote">At
                2,537 lines the parser is the largest single file. It handles the full
                grammar including CTEs, window functions, and set operations.</span></td>
        </tr>
        <tr>
            <td><strong>Query executor</strong></td>
            <td><code>query.c</code>, <code>database.c</code></td>
            <td>Walks the AST and executes against in-memory tables. Handles joins,
                aggregation, window functions, set operations, CTEs, subqueries,
                transactions</td>
        </tr>
        <tr>
            <td><strong>Storage</strong></td>
            <td><code>table.c</code>, <code>row.c</code>, <code>index.c</code></td>
            <td>Tables are arrays of rows; rows are arrays of typed cells. B-tree indexes
                for equality lookups. Snapshot-and-restore for transaction rollback</td>
        </tr>
    </tbody>
</table>

<p>
    All memory is managed explicitly. A generic dynamic-array macro
    (<code>dynamic_array.h</code>) and zero-copy string views
    (<code>stringview.h</code>) are the only internal abstractions.
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  3. Supported SQL                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="supported-sql">3. Supported SQL</h2>

<table>
    <thead>
        <tr><th>Category</th><th>Supported</th></tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>DDL</strong></td>
            <td><code>CREATE TABLE</code>, <code>DROP TABLE</code>,
                <code>CREATE INDEX</code>, <code>DROP INDEX</code>,
                <code>CREATE TYPE &hellip; AS ENUM</code>, <code>DROP TYPE</code>,
                <code>ALTER TABLE</code> (<code>ADD</code>/<code>DROP</code>/<code>RENAME COLUMN</code>,
                <code>ALTER COLUMN TYPE</code>)</td>
        </tr>
        <tr>
            <td><strong>DML</strong></td>
            <td><code>INSERT</code> (single, multi-row, <code>INSERT&hellip;SELECT</code>),
                <code>SELECT</code>, <code>UPDATE</code> (incl. <code>UPDATE&hellip;FROM</code>),
                <code>DELETE</code>,
                <code>RETURNING</code>, <code>ON CONFLICT DO NOTHING</code></td>
        </tr>
        <tr>
            <td><strong>Filtering</strong></td>
            <td><code>WHERE</code> with <code>AND</code>/<code>OR</code>/<code>NOT</code>,
                <code>BETWEEN</code>, <code>IN</code> (values &amp; subqueries),
                <code>LIKE</code>, <code>ILIKE</code>,
                <code>IS [NOT] NULL</code>, <code>IS [NOT] DISTINCT FROM</code>,
                <code>=</code> <code>!=</code> <code>&lt;&gt;</code>
                <code>&lt;</code> <code>&gt;</code> <code>&lt;=</code> <code>&gt;=</code></td>
        </tr>
        <tr>
            <td><strong>Joins</strong></td>
            <td><code>INNER</code>, <code>LEFT</code>, <code>RIGHT</code>,
                <code>FULL OUTER</code>, <code>CROSS</code>,
                <code>NATURAL</code>, <code>USING</code>, multi-table</td>
        </tr>
        <tr>
            <td><strong>Aggregation</strong></td>
            <td><code>COUNT</code>, <code>SUM</code>, <code>AVG</code>,
                <code>MIN</code>, <code>MAX</code>,
                <code>GROUP BY</code> (multi-column), <code>HAVING</code></td>
        </tr>
        <tr>
            <td><strong>Window functions</strong></td>
            <td><code>ROW_NUMBER()</code>, <code>RANK()</code>,
                <code>SUM()</code>, <code>COUNT()</code>, <code>AVG()</code>
                over <code>PARTITION BY &hellip; ORDER BY &hellip;</code></td>
        </tr>
        <tr>
            <td><strong>Set operations</strong></td>
            <td><code>UNION</code>, <code>UNION ALL</code>,
                <code>INTERSECT</code>, <code>EXCEPT</code></td>
        </tr>
        <tr>
            <td><strong>CTEs</strong></td>
            <td><code>WITH name AS (SELECT &hellip;) SELECT &hellip;</code></td>
        </tr>
        <tr>
            <td><strong>Expressions</strong></td>
            <td><code>+</code> <code>-</code> <code>*</code>,
                <code>CASE WHEN&hellip;THEN&hellip;ELSE&hellip;END</code>,
                <code>COALESCE()</code></td>
        </tr>
        <tr>
            <td><strong>Result control</strong></td>
            <td><code>DISTINCT</code>,
                <code>ORDER BY</code> (multi-column, per-column <code>ASC</code>/<code>DESC</code>),
                <code>LIMIT</code>, <code>OFFSET</code></td>
        </tr>
        <tr>
            <td><strong>Constraints</strong></td>
            <td><code>NOT NULL</code>, <code>UNIQUE</code>, <code>PRIMARY KEY</code>,
                <code>DEFAULT</code>, <code>CHECK</code></td>
        </tr>
        <tr>
            <td><strong>Transactions</strong></td>
            <td><code>BEGIN</code>, <code>COMMIT</code>, <code>ROLLBACK</code>
                (snapshot-based)</td>
        </tr>
    </tbody>
</table>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  4. Data Types                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="data-types">4. Data Types</h2>

<table>
    <thead>
        <tr><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr><td><code>INT</code></td><td>32-bit signed integer</td></tr>
        <tr><td><code>BIGINT</code></td><td>64-bit signed integer</td></tr>
        <tr><td><code>FLOAT</code></td><td>Double-precision floating point</td></tr>
        <tr><td><code>NUMERIC</code> / <code>DECIMAL</code></td><td>Decimal number</td></tr>
        <tr><td><code>TEXT</code></td><td>Variable-length string</td></tr>
        <tr><td><code>VARCHAR(n)</code></td><td>Length-bounded string</td></tr>
        <tr><td><code>BOOLEAN</code></td><td><code>TRUE</code> / <code>FALSE</code></td></tr>
        <tr><td><code>DATE</code></td><td>Calendar date</td></tr>
        <tr><td><code>TIMESTAMP</code></td><td>Date and time</td></tr>
        <tr><td><code>UUID</code></td><td>128-bit universally unique identifier</td></tr>
        <tr><td><code>SERIAL</code></td><td>Auto-incrementing integer</td></tr>
        <tr><td><code>ENUM</code></td><td>User-defined enumeration type</td></tr>
    </tbody>
</table>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  5. Getting Started                                         -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="getting-started">5. Getting Started</h2>

<p>
    Prerequisites: a C11 compiler and <code>make</code>. Nothing else.
</p>

<pre><code>make                                          # build
./build/mskql                                 # start server on port 5433
psql -h 127.0.0.1 -p 5433 -U test -d mskql   # connect</code></pre>

<p>Then run SQL as usual:</p>

<pre><code>CREATE TABLE users (
    id    INT PRIMARY KEY,
    name  TEXT NOT NULL,
    email TEXT UNIQUE
);

INSERT INTO users (id, name, email)
VALUES (1, 'Alice', 'alice@example.com');

SELECT * FROM users;</code></pre>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  6. Testing                                                 -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="testing">6. Testing</h2>

<p>
    The project includes 241 SQL test cases covering DDL, DML, joins, aggregation,
    window functions, set operations, CTEs, transactions, NULL handling, type coercion,
    constraint enforcement, and various edge cases.<span class="sidenote">Each test case
    starts a fresh server instance, sends SQL via <code>psql</code>, and validates output
    against expected results. No test framework&mdash;just shell scripts and
    <code>diff</code>.</span>
</p>

<pre><code>make test</code></pre>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  7. Benchmarks                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="benchmarks">7. Benchmarks</h2>

<p>
    A micro-benchmark suite measures wall-clock time for core operations: bulk insert,
    full-table scan, filtered select, aggregation, ordering, joins, update, delete,
    parsing, index lookup, and transactions. Results are tracked continuously via CI.
</p>

<p>
    &#8594;&ensp;<a href="dev/bench/index.html"><strong>View historical benchmark charts</strong></a>
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  8. How This Project Was Built                              -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2 id="construction">8. How This Project Was Built</h2>

<p>
    mskql was written entirely by AI through an adversarial collaboration between
    two agents. No human wrote any of the C code or SQL test cases.<span class="sidenote">The
    adversarial loop drove the implementation toward correctness the same way a rigorous
    code-review culture does on a human team&mdash;except both sides were machines.</span>
</p>

<div class="diagram">
<svg viewBox="0 0 620 340" xmlns="http://www.w3.org/2000/svg" font-family="'EB Garamond', Georgia, serif">
  <!-- Background -->
  <rect width="620" height="340" fill="#fffff8"/>

  <!-- Writer box -->
  <rect x="40" y="40" width="200" height="100" rx="6" fill="#fff" stroke="#111" stroke-width="1.5"/>
  <text x="140" y="72" text-anchor="middle" font-size="16" font-weight="600" fill="#111">The Writer</text>
  <text x="140" y="96" text-anchor="middle" font-size="12" fill="#555">Designs architecture</text>
  <text x="140" y="114" text-anchor="middle" font-size="12" fill="#555">Writes code &amp; fixes bugs</text>

  <!-- Challenger box -->
  <rect x="380" y="40" width="200" height="100" rx="6" fill="#fff" stroke="#111" stroke-width="1.5"/>
  <text x="480" y="72" text-anchor="middle" font-size="16" font-weight="600" fill="#111">The Challenger</text>
  <text x="480" y="96" text-anchor="middle" font-size="12" fill="#555">Reads source code</text>
  <text x="480" y="114" text-anchor="middle" font-size="12" fill="#555">Writes adversarial tests</text>

  <!-- Arrow: Writer -> Challenger (top) -->
  <defs>
    <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="#a00"/>
    </marker>
  </defs>
  <path d="M240,70 C310,70 310,70 380,70" stroke="#a00" stroke-width="1.5" fill="none" marker-end="url(#ah)"/>
  <text x="310" y="62" text-anchor="middle" font-size="11" fill="#a00" font-style="italic">production code</text>

  <!-- Arrow: Challenger -> Writer (bottom) -->
  <path d="M380,120 C310,120 310,120 240,120" stroke="#a00" stroke-width="1.5" fill="none" marker-end="url(#ah)"/>
  <text x="310" y="136" text-anchor="middle" font-size="11" fill="#a00" font-style="italic">.sql test cases</text>

  <!-- Cycle arrow down from both -->
  <path d="M140,140 L140,190 C140,210 140,210 200,210 L310,210" stroke="#ccc" stroke-width="1.2" fill="none" stroke-dasharray="4,3"/>
  <path d="M480,140 L480,190 C480,210 480,210 420,210 L310,210" stroke="#ccc" stroke-width="1.2" fill="none" stroke-dasharray="4,3"/>

  <!-- Iteration circle -->
  <circle cx="310" cy="210" r="22" fill="#fff" stroke="#a00" stroke-width="1.5"/>
  <text x="310" y="206" text-anchor="middle" font-size="10" fill="#a00" font-weight="600">iterate</text>
  <text x="310" y="218" text-anchor="middle" font-size="10" fill="#a00" font-weight="600">rounds</text>

  <!-- Arrow down to result -->
  <line x1="310" y1="232" x2="310" y2="270" stroke="#a00" stroke-width="1.5" marker-end="url(#ah)"/>

  <!-- Result box -->
  <rect x="180" y="275" width="260" height="48" rx="6" fill="#a00" stroke="none"/>
  <text x="310" y="296" text-anchor="middle" font-size="14" fill="#fff" font-weight="600">241 tests pass</text>
  <text x="310" y="314" text-anchor="middle" font-size="12" fill="rgba(255,255,255,0.8)">~8,200 lines of C &middot; zero human code</text>
</svg>
</div>

<p>
    The two agents worked in iterative rounds. The Challenger would study the current
    codebase and produce <code>.sql</code> test files exercising corner
    cases&mdash;empty tables, NULL handling, multi-column ordering, stale index entries
    after deletes, and more. The Writer would then run the new tests, diagnose failures,
    and ship fixes. This continued until the full suite passed cleanly.
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  Footer                                                     -->
<!-- ═══════════════════════════════════════════════════════════ -->

<footer class="site-footer">
    <a href="https://github.com/martinsk/mskql">Source on GitHub</a>
    &ensp;&middot;&ensp;
    <a href="dev/bench/index.html">Benchmarks</a>
</footer>

</body>
</html>
