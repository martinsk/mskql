<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mskql &mdash; How This Project Was Built</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<p class="breadcrumb"><a href="index.html">&larr; mskql</a></p>

<h1>Construction</h1>
<span class="subtitle">Adversarial AI collaboration &mdash; zero human code</span>
<hr class="title-rule">

<p>
    <strong>~39K lines of C. 1,240+ tests. Zero human code.</strong>
    Three AI agents&mdash;Challenger, Writer, Reviewer&mdash;collaborated in
    adversarial rounds until every test passed under AddressSanitizer.
    The result beats PostgreSQL on all 28 cached batch benchmarks and
    DuckDB on 37 of 84 workloads.
</p>

<div class="diagram">
<svg viewBox="0 0 620 240" xmlns="http://www.w3.org/2000/svg" font-family="'EB Garamond', Georgia, serif">
  <rect width="620" height="240" fill="#fffff8"/>
  <defs>
    <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="#a00"/>
    </marker>
  </defs>

  <!-- The Challenger (left) -->
  <rect x="20" y="20" width="160" height="80" rx="6" fill="#fff" stroke="#111" stroke-width="1.5"/>
  <text x="100" y="50" text-anchor="middle" font-size="15" font-weight="600" fill="#111">The Challenger</text>
  <text x="100" y="72" text-anchor="middle" font-size="11" fill="#555">adversarial test cases</text>

  <!-- The Writer (center) -->
  <rect x="230" y="20" width="160" height="80" rx="6" fill="#fff" stroke="#111" stroke-width="1.5"/>
  <text x="310" y="50" text-anchor="middle" font-size="15" font-weight="600" fill="#111">The Writer</text>
  <text x="310" y="72" text-anchor="middle" font-size="11" fill="#555">writes &amp; fixes code</text>

  <!-- The Reviewer (right) -->
  <rect x="440" y="20" width="160" height="80" rx="6" fill="#fff" stroke="#111" stroke-width="1.5"/>
  <text x="520" y="50" text-anchor="middle" font-size="15" font-weight="600" fill="#111">The Reviewer</text>
  <text x="520" y="72" text-anchor="middle" font-size="11" fill="#555">actionable comments</text>

  <!-- Challenger ↔ Writer arrows -->
  <path d="M180,45 L230,45" stroke="#a00" stroke-width="1.5" fill="none" marker-end="url(#ah)"/>
  <path d="M230,75 L180,75" stroke="#a00" stroke-width="1.5" fill="none" marker-end="url(#ah)"/>
  <text x="205" y="38" text-anchor="middle" font-size="9" fill="#a00" font-style="italic">tests</text>
  <text x="205" y="90" text-anchor="middle" font-size="9" fill="#a00" font-style="italic">fixes</text>

  <!-- Writer ↔ Reviewer arrows -->
  <path d="M390,45 L440,45" stroke="#a00" stroke-width="1.5" fill="none" marker-end="url(#ah)"/>
  <path d="M440,75 L390,75" stroke="#a00" stroke-width="1.5" fill="none" marker-end="url(#ah)"/>
  <text x="415" y="38" text-anchor="middle" font-size="9" fill="#a00" font-style="italic">code</text>
  <text x="415" y="90" text-anchor="middle" font-size="9" fill="#a00" font-style="italic">feedback</text>

  <!-- Loop arrow -->
  <path d="M520,100 C520,130 310,140 100,130 C60,128 40,120 40,100"
        stroke="#ccc" stroke-width="1.2" fill="none" stroke-dasharray="4,3"/>
  <text x="310" y="148" text-anchor="middle" font-size="11" fill="#555" font-style="italic">iterate until stable</text>

  <!-- Result box -->
  <rect x="160" y="165" width="300" height="48" rx="6" fill="#a00" stroke="none"/>
  <text x="310" y="186" text-anchor="middle" font-size="14" fill="#fff" font-weight="600">1,240+ tests pass</text>
  <text x="310" y="204" text-anchor="middle" font-size="11" fill="rgba(255,255,255,0.8)">~39,000 lines of C &middot; zero human code</text>
</svg>
</div>

<p>
    The three agents worked in iterative rounds. The Challenger would study the current
    codebase and produce <code>.sql</code> test files exercising corner
    cases&mdash;empty tables, NULL handling, multi-column ordering, stale index entries
    after deletes, and more. The Reviewer would read the source and annotate it with
    actionable comments flagging code-quality issues, missing edge-case handling,
    and architectural improvements. The Writer would then run the new tests, address the
    comments, diagnose failures, and ship fixes. This continued until the full suite passed
    cleanly.
</p>

<h2 id="agents">The three agents</h2>

<p>
    <strong>The Challenger</strong> studies the current codebase and produces
    <code>.sql</code> test files targeting corner cases: empty tables, NULL
    propagation through expressions, multi-column ordering with mixed
    ASC/DESC, stale index entries after deletes, concurrent readers during
    writes, and edge cases in type casting. Each round adds 10&ndash;30 new
    tests.
</p>

<p>
    <strong>The Writer</strong> runs the new tests under AddressSanitizer,
    diagnoses failures, and ships fixes. It also implements new features
    requested by the test suite&mdash;if the Challenger writes a test for
    <code>INTERSECT ALL</code>, the Writer adds the parser rule, executor
    path, and wire serialisation to make it pass.
</p>

<p>
    <strong>The Reviewer</strong> reads the source after each round and
    annotates it with actionable comments: missing error paths, redundant
    allocations, opportunities to share code between the plan executor and
    legacy row-by-row path, and architectural improvements like converting
    ENUM storage from string-based to ordinal.
</p>

<h2 id="feedback-loop">The feedback loop</h2>

<p>
    Write code, run 1,240+ tests, fix failures, repeat. The adversarial model
    drove correctness the same way rigorous code review does on a human
    team&mdash;except all three sides were machines. A typical round:
</p>

<ol>
    <li>Challenger adds tests for a new feature or edge case.</li>
    <li>Writer implements the feature and fixes any regressions.</li>
    <li>Reviewer flags code-quality issues and suggests refactors.</li>
    <li>Writer addresses review comments and re-runs the full suite.</li>
    <li>Repeat until all tests pass under ASAN with zero leaks.</li>
</ol>

<h2 id="result">What came out</h2>

<p>
    The result: a recursive-descent parser, block-oriented columnar executor,
    arena-based memory management with bump allocation, a result cache for
    repeat queries, and a PostgreSQL-compatible wire protocol&mdash;all
    without a single line of human-written C.
</p>

<p>
    Key architectural decisions that emerged from this process:
</p>

<ul>
    <li><strong>Columnar plan executor</strong> &mdash; processes data in 1024-row
        blocks with typed arrays, avoiding per-row dispatch overhead.</li>
    <li><strong>Bump allocator</strong> &mdash; slab-chained arena for parser and
        scratch memory; zero per-request allocations at steady state.</li>
    <li><strong>Result cache</strong> &mdash; caches serialised wire bytes keyed by
        SQL text; serves repeat queries in microseconds.</li>
    <li><strong>Direct columnar&rarr;wire send</strong> &mdash; bypasses row-store
        materialisation, batching DataRow messages into 64KB writes.</li>
    <li><strong>Native ordinal ENUMs</strong> &mdash; stored as <code>int32_t</code>
        internally, converted at I/O boundaries only.</li>
</ul>

<h2 id="now-what">Explore further</h2>

<p>
    <a href="architecture.html">Architecture</a> &ensp;&middot;&ensp;
    <a href="bench-vs-pg.html">Benchmarks</a> &ensp;&middot;&ensp;
    <a href="testing.html">Testing methodology</a> &ensp;&middot;&ensp;
    <a href="playground.html">Try it in the browser</a>
</p>

<footer class="site-footer">
    <a href="https://www.linkedin.com/in/martinskristiansen">Martin S. Kristiansen</a>
    &ensp;&middot;&ensp;
    <a href="https://github.com/martinsk/mskql">Source on GitHub</a>
    &ensp;&middot;&ensp;
    <a href="index.html">Documentation</a>
</footer>

</body>
</html>
