<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mskql &mdash; mskql vs PostgreSQL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .caveat {
            border: 1.5px solid var(--accent);
            border-radius: 6px;
            padding: 1rem 1.2rem;
            margin: 1.6rem 0;
            background: #fff;
        }
        .caveat strong { color: var(--accent); }

        .faster { color: #1a7a1a; font-weight: 600; }
        .slower { color: var(--accent); font-weight: 600; }

        .bar-cell { padding-right: 0; }
        .bar-wrap {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bar {
            height: 14px;
            border-radius: 2px;
            min-width: 2px;
        }
        .bar-mskql { background: var(--accent); }
        .bar-pg { background: #4a7ab5; }

        .legend {
            display: flex;
            gap: 1.5rem;
            font-size: 0.95rem;
            color: var(--fg-dim);
            margin-bottom: 0.8rem;
        }
        .legend-swatch {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 2px;
            vertical-align: middle;
            margin-right: 0.3rem;
        }

        .group-label td {
            padding-top: 1rem;
            font-variant: small-caps;
            letter-spacing: 0.04em;
            font-size: 0.85rem;
            color: var(--fg-dim);
            border-bottom: 1px solid var(--rule);
        }

        .tp-higher { color: #1a7a1a; font-weight: 600; }
        .tp-lower { color: var(--accent); font-weight: 600; }
    </style>
</head>
<body>

<p class="breadcrumb"><a href="index.html">&larr; mskql</a></p>

<h1>mskql vs PostgreSQL</h1>
<span class="subtitle">Two benchmarks, one honest picture</span>
<p class="byline">
    <a href="index.html">&#8592; back to main page</a>
</p>
<hr class="title-rule">

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  WHAT: Setup and framing                                    -->
<!-- ═══════════════════════════════════════════════════════════ -->

<div class="caveat">
    <strong>&#9888; Important caveat.</strong>&ensp;This comparison is <em>unscientific</em>
    and intended only as a directional indicator. mskql is an in-memory toy database with
    no durability, no MVCC, no WAL, no background workers, and no query optimizer.
    PostgreSQL is a production-grade RDBMS with decades of engineering behind it.
    The numbers below measure wall-clock time for identical SQL workloads over a loopback
    TCP connection&mdash;not raw engine speed. Take them as a rough sense of where mskql
    sits, not as a serious benchmark.
</div>

<h2>1. Methodology</h2>

<h3>Batch latency</h3>
<p>
    Both databases are tested on the same Apple&nbsp;M-series laptop, same loopback interface,
    using the same <code>psql</code> client. The benchmark script
    (<code>bench/bench_vs_pg.py</code>) generates identical SQL workloads for each test,
    runs setup against both databases, then times the benchmark queries. Each timing measures
    a single <code>psql&nbsp;-f</code> invocation containing all iterations of that workload.
    mskql runs on port&nbsp;5433; PostgreSQL on port&nbsp;5432 with default configuration.
</p>

<h3>Concurrent throughput</h3>
<p>
    A multi-threaded C benchmark (<code>bench/bench_throughput.c</code>) opens 10 persistent
    <code>libpq</code> connections to each database and fires queries as fast as possible for
    5&nbsp;seconds per workload. It measures queries-per-second (QPS) and median latency (p50).
    This tests how each database handles concurrent load&mdash;a fundamentally different
    dimension from single-client batch timing.
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  SO WHAT: The data                                          -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2>2. Batch Latency (single client, sequential)</h2>

<p>
    Ratio &lt;&nbsp;1.0 means mskql was faster; &gt;&nbsp;1.0 means PostgreSQL was faster.
    Results vary between runs&mdash;treat these as order-of-magnitude indicators.
</p>

<div class="legend">
    <span><span class="legend-swatch" style="background:var(--accent)"></span>mskql</span>
    <span><span class="legend-swatch" style="background:#4a7ab5"></span>PostgreSQL</span>
</div>

<table>
    <thead>
        <tr>
            <th>Workload</th>
            <th class="num" style="text-align:right">mskql&ensp;(ms)</th>
            <th class="num" style="text-align:right">pg&ensp;(ms)</th>
            <th class="num" style="text-align:right">Ratio</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        <tr class="group-label"><td colspan="5">reads</td></tr>
        <tr>
            <td><strong>select_full_scan</strong></td>
            <td class="num">281</td>
            <td class="num">417</td>
            <td class="num"><span class="faster">0.67&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:67%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>select_where</strong></td>
            <td class="num">354</td>
            <td class="num">589</td>
            <td class="num"><span class="faster">0.60&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:60%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>index_lookup</strong></td>
            <td class="num">103</td>
            <td class="num">108</td>
            <td class="num"><span class="faster">0.95&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:95%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>order_by</strong></td>
            <td class="num">196</td>
            <td class="num">372</td>
            <td class="num"><span class="faster">0.53&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:53%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>multi_sort</strong></td>
            <td class="num">268</td>
            <td class="num">516</td>
            <td class="num"><span class="faster">0.52&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:52%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>distinct</strong></td>
            <td class="num">44</td>
            <td class="num">250</td>
            <td class="num"><span class="faster">0.18&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:18%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr class="group-label"><td colspan="5">writes</td></tr>
        <tr>
            <td><strong>insert_bulk</strong></td>
            <td class="num">412</td>
            <td class="num">878</td>
            <td class="num"><span class="faster">0.47&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:47%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>update</strong></td>
            <td class="num">49</td>
            <td class="num">232</td>
            <td class="num"><span class="faster">0.21&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:21%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>delete</strong></td>
            <td class="num">3,780</td>
            <td class="num">7,680</td>
            <td class="num"><span class="faster">0.49&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:49%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>transaction</strong></td>
            <td class="num">265</td>
            <td class="num">191</td>
            <td class="num"><span class="slower">1.39&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:72%"></span></div></td>
        </tr>
        <tr class="group-label"><td colspan="5">advanced queries</td></tr>
        <tr>
            <td><strong>aggregate</strong></td>
            <td class="num">43</td>
            <td class="num">269</td>
            <td class="num"><span class="faster">0.16&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:16%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>join</strong></td>
            <td class="num">27</td>
            <td class="num">58</td>
            <td class="num"><span class="faster">0.47&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:47%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>window_functions</strong></td>
            <td class="num">49</td>
            <td class="num">86</td>
            <td class="num"><span class="faster">0.57&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:57%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>subquery</strong></td>
            <td class="num">41</td>
            <td class="num">93</td>
            <td class="num"><span class="faster">0.44&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:44%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>cte</strong></td>
            <td class="num">123</td>
            <td class="num">111</td>
            <td class="num"><span class="slower">1.11&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:90%"></span></div></td>
        </tr>
        <tr>
            <td><strong>set_ops</strong></td>
            <td class="num">54</td>
            <td class="num">97</td>
            <td class="num"><span class="faster">0.56&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:56%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>generate_series</strong></td>
            <td class="num">212</td>
            <td class="num">736</td>
            <td class="num"><span class="faster">0.29&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:29%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>scalar_functions</strong></td>
            <td class="num">357</td>
            <td class="num">928</td>
            <td class="num"><span class="faster">0.39&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:39%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>expression_agg</strong></td>
            <td class="num">302</td>
            <td class="num">303</td>
            <td class="num"><span class="faster">1.00&times;</span></td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
    </tbody>
</table>

<p>
    <strong>17 of 19 workloads faster.</strong>&ensp;The two exceptions are transactions
    (1.39&times;) and CTEs (1.11&times;). Expression aggregates are dead even at 1.00&times;.
</p>

<h2>3. Concurrent Throughput (10 threads, 5&nbsp;seconds)</h2>

<p>
    The batch numbers above measure a single client sending queries sequentially.
    The table below shows what happens when 10&nbsp;clients hit the database simultaneously.
    Ratio &gt;&nbsp;1.0 means mskql has higher throughput; &lt;&nbsp;1.0 means PostgreSQL does.
</p>

<div class="legend">
    <span><span class="legend-swatch" style="background:var(--accent)"></span>mskql</span>
    <span><span class="legend-swatch" style="background:#4a7ab5"></span>PostgreSQL</span>
</div>

<table>
    <thead>
        <tr>
            <th>Workload</th>
            <th class="num" style="text-align:right">mskql QPS</th>
            <th class="num" style="text-align:right">pg QPS</th>
            <th class="num" style="text-align:right">Ratio</th>
            <th class="num" style="text-align:right">mskql p50</th>
            <th class="num" style="text-align:right">pg p50</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>point_read</strong></td>
            <td class="num">43,450</td>
            <td class="num">58,643</td>
            <td class="num"><span class="tp-lower">0.74&times;</span></td>
            <td class="num">0.23&thinsp;ms</td>
            <td class="num">0.17&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:74%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>full_scan</strong></td>
            <td class="num">72</td>
            <td class="num">71</td>
            <td class="num"><span class="tp-higher">1.00&times;</span></td>
            <td class="num">138.6&thinsp;ms</td>
            <td class="num">138.6&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>filtered_scan</strong></td>
            <td class="num">144</td>
            <td class="num">144</td>
            <td class="num"><span class="tp-higher">1.00&times;</span></td>
            <td class="num">69.4&thinsp;ms</td>
            <td class="num">69.3&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>aggregate</strong></td>
            <td class="num">36,983</td>
            <td class="num">14,508</td>
            <td class="num"><span class="tp-higher">2.55&times;</span></td>
            <td class="num">0.28&thinsp;ms</td>
            <td class="num">0.65&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:39%"></span></div></td>
        </tr>
        <tr>
            <td><strong>join</strong></td>
            <td class="num">352</td>
            <td class="num">52,154</td>
            <td class="num"><span class="tp-lower">0.01&times;</span></td>
            <td class="num">28.4&thinsp;ms</td>
            <td class="num">0.19&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:1%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
        <tr>
            <td><strong>insert</strong></td>
            <td class="num">47,932</td>
            <td class="num">40,286</td>
            <td class="num"><span class="tp-higher">1.19&times;</span></td>
            <td class="num">0.22&thinsp;ms</td>
            <td class="num">0.24&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:100%"></span><span class="bar bar-pg" style="width:84%"></span></div></td>
        </tr>
        <tr>
            <td><strong>mixed_rw</strong></td>
            <td class="num">41,716</td>
            <td class="num">56,755</td>
            <td class="num"><span class="tp-lower">0.74&times;</span></td>
            <td class="num">0.25&thinsp;ms</td>
            <td class="num">0.17&thinsp;ms</td>
            <td class="bar-cell"><div class="bar-wrap"><span class="bar bar-mskql" style="width:74%"></span><span class="bar bar-pg" style="width:100%"></span></div></td>
        </tr>
    </tbody>
</table>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  SO WHAT: The honest picture                                -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2>4. The Honest Picture</h2>

<h3>Where mskql wins</h3>

<p>
    In batch latency, mskql is faster in 17&nbsp;of&nbsp;19 workloads. The biggest wins
    are <strong>aggregate</strong> at 0.16&times; (6&times; faster) and
    <strong>distinct</strong> at 0.18&times; (5.5&times; faster), both driven by the
    block-oriented plan executor&mdash;a columnar engine that processes data in 1,024-row
    blocks and serializes results directly to the wire protocol without materializing
    individual rows. A scan cache with generation tracking avoids redundant row-store
    traversals when the underlying table hasn&rsquo;t changed.
</p>

<p>
    Write-heavy workloads benefit from zero durability overhead: no fsync, no WAL, no MVCC
    bookkeeping. Updates at 0.21&times; and deletes at 0.49&times; are the expected
    advantage of an in-memory toy database&mdash;not a fair comparison for production use.
</p>

<p>
    Under concurrent load, mskql&rsquo;s aggregate throughput is 2.55&times; PostgreSQL&rsquo;s.
    Each aggregate query completes in 0.28&thinsp;ms (vs 0.65&thinsp;ms in PG), and the
    single-threaded event loop can service ~37K of these tiny queries per second without
    context-switch overhead. Insert throughput is 1.19&times; for the same reason.
</p>

<h3>Where mskql loses</h3>

<p>
    <strong>Concurrent joins: 0.01&times;.</strong>&ensp;This is the most striking number
    in the table, and it reveals mskql&rsquo;s fundamental architectural limitation.
    mskql runs a single-threaded event loop&mdash;every query executes while holding a
    global lock. A hash join that takes ~28&thinsp;ms blocks all other clients for that
    entire duration. PostgreSQL, by contrast, forks a separate backend per connection,
    so 10&nbsp;clients run 10&nbsp;joins in parallel. The result: PostgreSQL delivers
    52,154&nbsp;QPS while mskql manages 352.
</p>

<p>
    <strong>Point reads and mixed R/W: 0.74&times;.</strong>&ensp;Same root cause.
    Each point read is fast (~0.23&thinsp;ms), but 10&nbsp;threads contend for the
    single event loop. PostgreSQL&rsquo;s per-connection backends avoid this serialization
    entirely.
</p>

<p>
    <strong>Full scans and filtered scans: 1.00&times;.</strong>&ensp;These tie because
    both databases are bottlenecked on the same thing&mdash;serializing ~5,000 rows over
    the wire per query. The scan itself is fast in both; the network dominates.
</p>

<p>
    <strong>Transactions: 1.39&times;.</strong>&ensp;PostgreSQL&rsquo;s WAL-based commit
    path is highly optimized for batched fsync. mskql&rsquo;s snapshot-based rollback
    mechanism deep-copies table state on <code>BEGIN</code>, which is expensive for
    tables with many rows.
</p>

<p>
    <strong>CTEs: 1.11&times;.</strong>&ensp;CTE materialization in mskql creates a
    temporary table per <code>WITH</code> clause. PostgreSQL&rsquo;s optimizer can
    sometimes inline CTEs or pipeline them, avoiding the materialization cost.
</p>

<!-- ═══════════════════════════════════════════════════════════ -->
<!--  NOW WHAT: Next steps and reproduction                      -->
<!-- ═══════════════════════════════════════════════════════════ -->

<h2>5. What&rsquo;s Next</h2>

<p>
    The throughput gap is the clearest signal in this data. mskql&rsquo;s single-threaded
    event loop is the bottleneck&mdash;not the query engine itself. A work-stealing
    executor or per-connection query dispatch would close the gap on concurrent workloads
    without changing the storage engine or plan executor. That&rsquo;s the next frontier.
</p>

<h2>6. Running It Yourself</h2>

<h3>Batch latency</h3>
<pre><code class="language-bash"># Start mskql in one terminal
./build/mskql

# In another terminal, with PostgreSQL running:
./bench/bench_vs_pg.sh</code></pre>

<h3>Concurrent throughput</h3>
<pre><code class="language-bash"># Build the throughput benchmark
make -C bench bench_throughput

# Run (requires both mskql and PostgreSQL running)
./build/mskql_bench_tp --duration 5 --threads 10 --pg</code></pre>

<p>
    The batch script auto-creates a <code>mskql_bench</code> database in PostgreSQL if it
    doesn&rsquo;t exist. The throughput benchmark requires <code>libpq</code> headers
    at build time.
</p>

<footer class="site-footer">
    <a href="index.html">mskql</a>
    &ensp;&middot;&ensp;
    <a href="https://github.com/martinsk/mskql">Source on GitHub</a>
    &ensp;&middot;&ensp;
    <a href="dev/bench/index.html">Historical Charts</a>
    &ensp;&middot;&ensp;
    <a href="grammar.html">SQL Grammar</a>
</footer>

</body>
</html>
