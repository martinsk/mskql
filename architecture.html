<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mskql &mdash; Architecture</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<p class="breadcrumb"><a href="index.html">&larr; mskql</a></p>

<h1>Architecture</h1>
<span class="subtitle">Four-stage pipeline from wire to storage</span>
<hr class="title-rule">

<p>
    <strong>~24K lines of C. Zero dependencies. Four stages: wire protocol, parser,
    executor, storage.</strong> Every query flows through the same pipeline.
    The block-oriented plan executor processes 1,024-row column blocks for
    cache-friendly, vectorized execution.
</p>

<h2 id="pipeline">The pipeline</h2>

<p>
    Every query passes through four stages:
</p>

<table>
    <thead>
        <tr><th>Stage</th><th>Source</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Wire protocol</strong></td>
            <td><code>pgwire.c</code></td>
            <td>Accepts TCP connections on port&nbsp;5433, handles SSL negotiation,
                implements the Simple Query, Extended Query (prepared
                statements, portals, <code>$1</code>/<code>$2</code> parameter
                substitution), and COPY protocols (tab-delimited and CSV),
                intercepts <code>information_schema</code> and
                <code>pg_catalog</code> queries for tool compatibility,
                and serializes result rows</td>
        </tr>
        <tr>
            <td><strong>SQL parser</strong></td>
            <td><code>parser.c</code></td>
            <td>Hand-written recursive-descent parser producing a typed
                <code>struct&nbsp;query</code> AST&mdash;no generators.
                ~4,500 lines with proper operator precedence,
                CTEs, window functions, set operations, and
                <code>generate_series()</code> table functions</td>
        </tr>
        <tr>
            <td><strong>Query executor</strong></td>
            <td><code>query.c</code>, <code>database.c</code></td>
            <td>Block-oriented plan executor (<code>plan.c</code>, ~4,500 lines)
                handles most queries with vectorized operators: scan, filter,
                project, sort, hash join, hash aggregation, index scan,
                window functions, set operations, CTEs, and
                <code>generate_series()</code>.
                A scan cache with generation tracking skips redundant scans.
                Direct columnar-to-wire serialization bypasses row materialization.
                Complex queries (correlated subqueries, <code>ROLLUP</code>/<code>CUBE</code>)
                fall back to the legacy row-at-a-time evaluator
                (<code>query.c</code>, <code>database.c</code>)</td>
        </tr>
        <tr>
            <td><strong>Storage</strong></td>
            <td><code>table.c</code>, <code>row.c</code>, <code>index.c</code></td>
            <td>Tables are arrays of rows; rows are arrays of typed cells. B-tree indexes
                for equality lookups. Snapshot-and-restore for transaction rollback</td>
        </tr>
    </tbody>
</table>

<h2 id="memory">Memory management</h2>

<h3>Arena allocator</h3>
<p>
    All memory is managed through a pool-based arena (<code>arena.h</code>).
    Parsed structures use <code>uint32_t</code> indices instead of pointers.
    Freeing an entire query is one <code>query_arena_destroy()</code> call&mdash;no
    recursive walks, no per-node <code>free()</code>.
</p>

<h3>Bump allocators</h3>
<p>
    A slab-chain bump allocator (<code>arena.scratch</code>) handles temporary
    executor state: aggregate accumulators, sort buffers, window-function arrays.
    All freed in bulk per query&mdash;zero <code>malloc</code>/<code>free</code>
    calls at steady state. A separate result-text bump allocator
    (<code>arena.result_text</code>) eliminates per-cell <code>strdup</code>
    for text results.
</p>

<h3>Expression evaluator</h3>
<p>
    Expressions are a tagged-union AST (<code>struct&nbsp;expr</code>) evaluated
    by <code>eval_expr()</code>. Supports <code>CAST</code>/<code>::</code>,
    date/time arithmetic, 30+ built-in scalar functions (math, string, temporal),
    <code>CASE&nbsp;WHEN</code>, and subqueries.
</p>

<h3>Internal abstractions</h3>
<p>
    Dynamic-array macro (<code>dynamic_array.h</code>), zero-copy string views
    (<code>stringview.h</code>), and JPL-style ownership: the allocating module
    deallocates.
</p>

<h2 id="so-what">Why this design</h2>

<p>
    <strong>Fast.</strong> The block-oriented executor with columnar scan caching
    beats PostgreSQL on 16 of 19 batch benchmarks. Aggregate queries run 8&times;
    faster. Direct columnar-to-wire serialization avoids row materialization entirely.
</p>
<p>
    <strong>Simple.</strong> Zero external dependencies. One <code>.c</code> file per
    stage. The entire codebase fits in a single developer&rsquo;s head.
</p>
<p>
    <strong>Safe.</strong> Every test runs under AddressSanitizer. Arena allocation
    eliminates use-after-free and leak classes by construction.
</p>

<h2 id="now-what">Explore further</h2>

<p>
    <a href="bench-vs-pg.html">Benchmarks vs PostgreSQL</a> &ensp;&middot;&ensp;
    <a href="grammar.html">SQL grammar</a> &ensp;&middot;&ensp;
    <a href="https://github.com/martinsk/mskql">Source on GitHub</a> &ensp;&middot;&ensp;
    <a href="playground.html">Try it in the browser</a>
</p>

<footer class="site-footer">
    <a href="https://www.linkedin.com/in/martinskristiansen">Martin S. Kristiansen</a>
    &ensp;&middot;&ensp;
    <a href="https://github.com/martinsk/mskql">Source on GitHub</a>
    &ensp;&middot;&ensp;
    <a href="index.html">Documentation</a>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
<script>hljs.highlightAll();</script>
</body>
</html>
